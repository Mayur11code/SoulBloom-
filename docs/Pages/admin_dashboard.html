<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'VT323', monospace;
            background-color: #1a202c;
            color: #e2e8f0;
        }

        /* Style for the AI-generated report text */
        .report-text {
            white-space: pre-wrap;
            /* Preserves whitespace and wraps text */
            font-family: sans-serif;
            /* Use a more readable font for the report body */
            font-size: 0.9rem;
            line-height: 1.5;
        }
    </style>
</head>

<body class="p-8">
    <div class="max-w-7xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl text-red-400 flex items-center gap-3"><i data-lucide="shield-alert" class="w-8 h-8"></i>
                Admin Monitor</h1>
        </div>

        <!-- START OF EDIT: Added Error Display Section -->
        <div id="error-section" class="hidden bg-red-900/50 border border-red-700 text-red-200 p-4 rounded-lg mb-6">
            <div class="flex items-center gap-3 mb-2">
                <i data-lucide="alert-triangle" class="w-6 h-6"></i>
                <h3 class="text-xl font-bold">Firestore Security Alert</h3>
            </div>
            <p id="error-message" class="font-mono text-sm"></p>
            <div class="mt-4 bg-gray-900 p-3 rounded">
                <p class="text-gray-400 mb-2">This usually happens when your Firestore Security Rules don't allow this
                    admin dashboard to access user data. Please ensure your rules in the Firebase Console allow
                    authenticated users to read public data and write to user-specific notification paths. Here's a
                    sample rule structure:</p>
                <pre class="text-xs text-yellow-300 whitespace-pre-wrap"><code>
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Admins need to read public data like reports and flagged users
    match /artifacts/{appId}/public/data/{document=**} {
      allow read: if request.auth != null;
      // Let students write their own public data
      allow write: if request.auth != null && request.auth.uid == request.resource.data.userId;
    }

    // Admins need to write reminders to specific user notification collections
    match /artifacts/{appId}/users/{userId}/notifications/{docId} {
        allow read, write: if request.auth != null;
    }
  }
}
                </code></pre>
            </div>
        </div>
        <!-- END OF EDIT -->


        <!-- Flagged Users Section -->
        <div id="flagged-users-section">
            <h2 class="text-2xl text-red-400 mb-4">Flagged Users</h2>
            <p class="text-gray-400 mb-6">This list shows users with flagged content. For each user, you can view their
                health report if available, or send them a reminder to complete the screening.</p>

            <div class="bg-gray-800 rounded-lg border border-gray-700 shadow-lg">
                <div class="grid grid-cols-5 font-bold text-gray-400 p-4 border-b border-gray-700">
                    <div>Timestamp</div>
                    <div>User ID</div>
                    <div class="col-span-2">Flagged Message</div>
                    <div>Actions</div>
                </div>
                <div id="flagged-users-list" class="divide-y divide-gray-700">
                    <div id="loading-state" class="p-8 text-center text-gray-500">
                        <p>Connecting and authenticating...</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="report-viewer-section"
            class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50">
            <div class="bg-gray-800 rounded-lg border border-gray-700 shadow-2xl max-w-4xl w-full p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl text-indigo-400">Student Health Report</h2>
                    <button id="close-report-btn" class="text-gray-400 hover:text-white">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <div id="single-report-content" class="space-y-4">
                    <!-- Single report will be rendered here by JS -->
                </div>
            </div>
        </div>
    </div>

    <div id="notification-toast"
        class="hidden fixed bottom-5 right-5 bg-green-600 text-white p-3 rounded-lg shadow-lg z-50 text-base">
        <span id="notification-message"></span>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, getDocs, where, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOveO-NFW_X5FkINfh5KMgCBBMlOej8M4",
            authDomain: "student-dashboard-4ec02.firebaseapp.com",
            projectId: "student-dashboard-4ec02",
            storageBucket: "student-dashboard-4ec02.firebasestorage.app",
            messagingSenderId: "250478137189",
            appId: "1:250478137189:web:224352f8e017b4194edb8c"
        };
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const sanitizedAppId = appId.replace(/\//g, '_');

        let db, auth;

        try {
            const app = initializeApp(finalFirebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed.", e);
            document.getElementById('loading-state').textContent = 'Error: Firebase connection failed.';
        }

        const flaggedUsersList = document.getElementById('flagged-users-list');
        const loadingState = document.getElementById('loading-state');
        const reportViewerSection = document.getElementById('report-viewer-section');
        const closeReportBtn = document.getElementById('close-report-btn');
        const singleReportContent = document.getElementById('single-report-content');
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        // START OF EDIT: New Error DOM elements
        const errorSection = document.getElementById('error-section');
        const errorMessage = document.getElementById('error-message');
        // END OF EDIT

        // START OF EDIT: Added Error display function
        function showPermissionError(message) {
            errorMessage.textContent = message;
            errorSection.classList.remove('hidden');
        }
        // END OF EDIT

        function showToast(message, type = 'success') {
            notificationMessage.textContent = message;
            notificationToast.classList.remove('hidden', 'bg-green-600', 'bg-blue-600', 'bg-red-600');
            let colorClass = 'bg-green-600';
            if (type === 'info') colorClass = 'bg-blue-600';
            if (type === 'error') colorClass = 'bg-red-600';
            notificationToast.classList.add(colorClass);
            setTimeout(() => {
                notificationToast.classList.add('hidden');
            }, 3000);
        }

        // START OF EDIT: Wrapped function logic in try/catch to handle permission errors
        async function checkReportStatus(userId, actionCell) {
            actionCell.innerHTML = `<div class="h-5 w-5 border-2 border-t-transparent border-gray-400 rounded-full animate-spin"></div>`;

            try {
                const reportsRef = collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`);
                const q = query(reportsRef, where("userId", "==", userId));
                const querySnapshot = await getDocs(q);

                actionCell.innerHTML = '';

                if (!querySnapshot.empty) {
                    const reportDoc = querySnapshot.docs[0];
                    const viewBtn = document.createElement('button');
                    viewBtn.className = "bg-indigo-600 text-white px-3 py-1 text-sm rounded hover:bg-indigo-700 transition-colors flex items-center gap-1";
                    viewBtn.innerHTML = `<i data-lucide="file-text" class="w-4 h-4"></i> View Report`;
                    viewBtn.onclick = () => displaySingleReport(reportDoc.data());
                    actionCell.appendChild(viewBtn);
                } else {
                    const remindBtn = document.createElement('button');
                    remindBtn.className = "bg-yellow-600 text-white px-3 py-1 text-sm rounded hover:bg-yellow-700 transition-colors flex items-center gap-1";
                    remindBtn.innerHTML = `<i data-lucide="bell-ring" class="w-4 h-4"></i> Send Reminder`;
                    remindBtn.onclick = async () => {
                        await sendScreeningReminder(userId, remindBtn);
                    };
                    actionCell.appendChild(remindBtn);
                }
                lucide.createIcons();
            } catch (error) {
                console.error("Error checking report status:", error);
                actionCell.innerHTML = `<span class="text-red-500 text-xs">Perm Error</span>`;
                if (error.code === 'permission-denied') {
                    showPermissionError('Could not check for health reports due to a permissions issue.');
                }
            }
        }
        // END OF EDIT

        function displaySingleReport(reportData) {
            const timestamp = reportData.createdAt?.toDate ? reportData.createdAt.toDate().toLocaleString() : 'N/A';
            singleReportContent.innerHTML = `
                <div class="grid grid-cols-3 gap-4 text-base">
                    <div><strong>User ID:</strong> <span class="font-mono text-cyan-400">${reportData.userId}</span></div>
                    <div><strong>Report Date:</strong> ${timestamp}</div>
                </div>
                 <div class="grid grid-cols-3 gap-4 text-base">
                    <div><strong>PHQ-9 Score:</strong> <span class="font-bold text-lg ${reportData.phqScore >= 10 ? 'text-yellow-400' : 'text-green-400'}">${reportData.phqScore}</span> / 27</div>
                    <div><strong>GAD-7 Score:</strong> <span class="font-bold text-lg ${reportData.gadScore >= 10 ? 'text-yellow-400' : 'text-green-400'}">${reportData.gadScore}</span> / 21</div>
                </div>
                <div class="pt-4 border-t border-gray-600">
                    <h3 class="text-lg text-gray-300 mb-2">AI-Generated Summary:</h3>
                    <div class="text-gray-200 bg-gray-900 p-3 rounded report-text">${reportData.report}</div>
                </div>
            `;
            reportViewerSection.classList.remove('hidden');
        }

        // START OF EDIT: Wrapped function logic in try/catch to handle permission errors
        async function sendScreeningReminder(userId, button) {
            button.disabled = true;
            button.textContent = 'Sending...';
            try {
                const notificationsRef = collection(db, `artifacts/${sanitizedAppId}/users/${userId}/notifications`);
                await addDoc(notificationsRef, {
                    title: "Wellness Check-in Recommended",
                    message: "A wellness check-in is recommended. Please take a moment to complete the Mental Health Screening.",
                    type: "screening_reminder",
                    read: false,
                    createdAt: serverTimestamp()
                });
                showToast(`Reminder sent to user ${userId.substring(0, 6)}...`, 'info');
                button.className = "bg-gray-500 text-white px-3 py-1 text-sm rounded cursor-not-allowed flex items-center gap-1";
                button.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Sent`;
                lucide.createIcons();
            } catch (error) {
                console.error("Failed to send reminder:", error);
                showToast("Error: Could not send reminder.", "error");
                button.disabled = false;
                button.textContent = 'Send Reminder';
                if (error.code === 'permission-denied') {
                    showPermissionError('Could not send a reminder due to a permissions issue.');
                }
            }
        }
        // END OF EDIT

        function listenForFlaggedUsers() {
            if (!db) return;

            const flaggedUsersRef = collection(db, `artifacts/${sanitizedAppId}/public/data/flagged_users`);
            const q = query(flaggedUsersRef);

            onSnapshot(q, (snapshot) => {
                if (snapshot.empty && !loadingState.classList.contains('hidden')) {
                    loadingState.innerHTML = `
                        <div class="flex flex-col items-center gap-4 py-8">
                            <i data-lucide="antenna" class="w-16 h-16 text-gray-600"></i>
                            <h2 class="text-xl text-gray-400">Monitoring Active</h2>
                            <p class="max-w-md">This dashboard is successfully connected and is now waiting for flagged content to be submitted from the student dashboard.</p>
                        </div>
                    `;
                    lucide.createIcons();
                } else if (!snapshot.empty) {
                    loadingState.classList.add('hidden');
                }

                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const userData = change.doc.data();
                        const newRow = document.createElement('div');
                        newRow.className = 'grid grid-cols-5 p-4 items-center bg-red-900/20 hover:bg-red-900/40 transition-colors duration-300';

                        const timestamp = userData.timestamp?.toDate ? userData.timestamp.toDate().toLocaleString() : 'N/A';

                        const actionCell = document.createElement('div');
                        actionCell.className = "flex justify-start";

                        newRow.innerHTML = `
                            <div class="text-sm text-gray-400">${timestamp}</div>
                            <div class="text-sm font-mono text-yellow-400" title="${userData.userId}">${userData.userId.substring(0, 12)}...</div>
                            <div class="col-span-2 text-sm text-gray-200 bg-gray-900 p-2 rounded">${userData.message}</div>
                        `;

                        newRow.appendChild(actionCell);
                        flaggedUsersList.prepend(newRow);

                        checkReportStatus(userData.userId, actionCell);
                    }
                });

            }, (error) => {
                console.error("Error listening for flagged users:", error);
                loadingState.innerHTML = `<div class="p-4 text-center text-red-500">Error listening for updates. Check your browser console.</div>`;
                if (error.code === 'permission-denied') {
                    showPermissionError('Could not listen for flagged users due to a permissions issue.');
                }
            });
        }

        function initializeAdminDashboard() {
            if (!auth) {
                loadingState.textContent = 'Error: Auth service not available.';
                return;
            };

            closeReportBtn.addEventListener('click', () => {
                reportViewerSection.classList.add('hidden');
            });

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("My Admin UID is:", user.uid);
                    listenForFlaggedUsers();
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Admin sign-in failed:", error);
                        loadingState.textContent = 'Error: Could not authenticate admin user.';
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initializeAdminDashboard();
        });

    </script>
</body>

</html>