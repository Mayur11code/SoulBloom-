<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Template Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Leaflet.js for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- START OF FIX: Added JSZip via a standard script tag -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- END OF FIX -->

    <!-- 
      The Google Sign-In script is loaded asynchronously. 
      The 'onGoogleScriptsLoad' function will be our single entry point
      to start the rest of the Google API initialization process.
    -->
    <script>
        // Set a global flag when the GSI script's onload callback fires.
        // This helps prevent a race condition with DOMContentLoaded.
        window.googleGsiIsReady = false;
        function onGoogleScriptsLoad() {
            window.googleGsiIsReady = true;
            // Dispatch a custom event to let our main script know the GSI client is ready.
            window.dispatchEvent(new Event('google-gsi-loaded'));
        }
    </script>
    <script src="https://accounts.google.com/gsi/client" onload="onGoogleScriptsLoad()" async defer></script>
    
</head>

<body class="p-4 md:p-8">

    <!-- Custom Notification Banner -->
    <div id="notification-banner" class="hidden fixed top-5 right-5 bg-green-500 text-white p-3 rounded-lg shadow-lg z-50 text-base">
        <span id="notification-message"></span>
        <button id="notification-close-btn" class="ml-4 font-bold">X</button>
    </div>

    <!-- Floating Elements Background -->
    <div class="floating-elements">
        <div class="floaty" style="width: 10px; height: 10px; left: 5%; animation-duration: 20s; animation-delay: 0s;">
        </div>
        <div class="floaty" style="width: 20px; height: 20px; left: 15%; animation-duration: 30s; animation-delay: 5s;">
        </div>
        <div class="floaty" style="width: 12px; height: 12px; left: 25%; animation-duration: 18s; animation-delay: 2s;">
        </div>
        <div class="floaty" style="width: 15px; height: 15px; left: 40%; animation-duration: 28s; animation-delay: 8s;">
        </div>
        <div class="floaty"
            style="width: 18px; height: 18px; left: 55%; animation-duration: 22s; animation-delay: 12s;"></div>
        <div class="floaty" style="width: 8px; height: 8px; left: 70%; animation-duration: 35s; animation-delay: 1s;">
        </div>
        <div class="floaty" style="width: 16px; height: 16px; left: 85%; animation-duration: 24s; animation-delay: 6s;">
        </div>
        <div class="floaty"
            style="width: 13px; height: 13px; left: 95%; animation-duration: 26s; animation-delay: 10s;"></div>
    </div>


    <div class="max-w-7xl mx-auto relative z-10">
       

        <!-- SOS Button -->
        <button id="sos-btn"
            class="fixed top-8 right-8 bg-orange-400 text-white p-3 rounded-full shadow-lg hover:bg-orange-500 transition-transform hover:scale-110 z-40">
            <i data-lucide="siren" class="w-6 h-6"></i>
        </button>

        <!-- Header Image -->
        <div class="pixelated-bg rounded-lg relative">
            <div class="absolute inset-0 bg-black/40 rounded-lg"></div> <!-- Brightness Overlay -->
            <div class="absolute -bottom-8 left-8">
                <button id="profile-pic-container"
                    class="bg-[#39414A]/50 backdrop-blur-[10px] p-3 rounded-lg border border-white/10 shadow-[0_0_20px_rgba(160,130,255,0.5)] transition-transform hover:scale-105">
                    <span id="profile-pic-emoji" class="text-5xl">‚òòÔ∏è</span>
                </button>
            </div>
            <div class="absolute bottom-4 left-32 text-2xl flex items-center gap-2">
                <span id="user-anonymous-name" class="font-bold"></span>
                
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 pt-6 mt-6">

            <!-- Sidebar -->
            <div class="lg:col-span-1 flex flex-col gap-6">
              
                <div class="widget">
                    <button id="study-help-btn" class="gradient-button-container w-full">
                        <div
                            class="bg-black rounded-lg p-3 text-center hover:bg-gray-900 transition-colors flex items-center justify-center gap-2 text-lg">
                            <i data-lucide="graduation-cap" class="w-5 h-5 text-yellow-400"></i>
                            <span>Study Help !!</span>
                        </div>
                    </button>
                </div>
                <div class="widget h-full">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl">Chat Rooms</h2>
                        <div class="flex items-center gap-2">
                            <button class="text-gray-400 hover:text-white"><i data-lucide="search"
                                    class="w-5 h-5"></i></button>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <button
                            class="chatroom-btn w-full text-left p-2 rounded hover:bg-white/10 transition-colors flex items-center gap-2"
                            data-room-name="General Chat">
                            <i data-lucide="message-square" class="w-4 h-4"></i> General Chat
                        </button>
                        <button
                            class="chatroom-btn w-full text-left p-2 rounded hover:bg-white/10 transition-colors flex items-center gap-2"
                            data-room-name="Study Group">
                            <i data-lucide="book-open" class="w-4 h-4"></i> Study Group
                        </button>
                        <button
                            class="chatroom-btn w-full text-left p-2 rounded hover:bg-white/10 transition-colors flex items-center gap-2"
                            data-room-name="Gaming Corner">
                            <i data-lucide="gamepad-2" class="w-4 h-4"></i> Gaming Corner
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="lg:col-span-3 grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Left Column -->
                <div class="lg:col-span-1 flex flex-col gap-6">
                    <!-- Helpful Links -->
                    <div class="widget">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl mb-3 flex items-center gap-2"><i data-lucide="link-2"
                                    class="w-5 h-5"></i> Helpful Links</h2>
                            <button id="helpful-link-btn"
                                class="text-sm bg-green-500/80 text-white px-3 py-1 rounded hover:bg-green-600">‚ú® Find a Link</button>
                        </div>
                        <ul id="helpful-links-list" class="space-y-2 mt-2">
                             <li><a href="https://telemanas.mohfw.gov.in/" target="_blank" class="hover:text-green-400">‚úß Tele MANAS</a></li>
                        </ul>
                    </div>

                    <!-- Journaling -->
                    <div class="widget">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl flex items-center gap-2"><i data-lucide="book-heart" class="w-5 h-5"></i>
                                Journaling</h2>
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <span>Local</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="journal-storage-toggle" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-500">
                                    </div>
                                </label>
                                <span>Server</span>
                                <button id="sync-journal-btn" class="ml-2 text-sm text-cyan-400 hover:text-cyan-300 hidden">Sync to Server</button>
                            </div>
                        </div>
                        <button id="shadow-work-prompt-btn"
                            class="w-full text-sm bg-purple-500/80 text-white px-3 py-2 rounded hover:bg-purple-600 mb-3">üîÆ
                            New Shadow Work Prompt</button>
                        <textarea id="journal-entry"
                            class="w-full h-32 bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-purple-400 text-base"
                            placeholder="What's on your mind?"></textarea>
                        <button id="save-journal-entry-btn"
                            class="w-full mt-2 text-sm bg-green-500/80 text-white px-3 py-2 rounded hover:bg-green-600">Save
                            Entry</button>

                        <div id="journal-history-container" class="mt-4">
                            <h3 class="text-lg mb-2">Past Entries</h3>
                            <div id="journal-history-list" class="space-y-2 max-h-40 overflow-y-auto pr-2">
                                <!-- Journal history will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- User Health -->
                    <div class="widget">
                        <h2 class="text-xl mb-4 flex items-center gap-2"><i data-lucide="heart-pulse"
                                class="w-5 h-5"></i> User Health</h2>
                        <div id="health-stats-container"
                            class="flex flex-col gap-6 items-center"
                            style="min-height: 150px;">
                            <!-- Health gauges will be injected here by JS -->
                        </div>
                        <div id="google-fit-auth-container" class="mt-4 text-center">
                            <!-- This will show a login button or a sync message -->
                        </div>
                    </div>

                    <!-- Weather -->
                    <div class="widget">
                        <h2 class="text-sm text-gray-400">DELHI WEATHER</h2>
                        <div class="flex items-center justify-between mt-2">
                            <p class="text-5xl">28¬∞C</p>
                            <div class="text-right">
                                <i data-lucide="cloud-sun" class="w-12 h-12 ml-auto"></i>
                                <p>broken clouds</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-600 flex justify-between text-center">
                            <div class="flex flex-col items-center">
                                <p>SAT</p>
                                <i data-lucide="sun" class="w-6 h-6 my-1"></i>
                                <p>38¬∞C</p>
                                <p class="text-gray-400">24¬∞C</p>
                            </div>
                            <div class="flex flex-col items-center">
                                <p>SUN</p>
                                <i data-lucide="cloud-sun" class="w-6 h-6 my-1"></i>
                                <p>35¬∞C</p>
                                <p class="text-gray-400">24¬∞C</p>
                            </div>
                            <div class="flex flex-col items-center">
                                <p>MON</p>
                                <i data-lucide="cloud-drizzle" class="w-6 h-6 my-1"></i>
                                <p>34¬∞C</p>
                                <p class="text-gray-400">21¬∞C</p>
                            </div>
                            <div class="flex flex-col items-center">
                                <p>TUE</p>
                                <i data-lucide="cloud-lightning" class="w-6 h-6 my-1"></i>
                                <p>31¬∞C</p>
                                <p class="text-gray-400">18¬∞C</p>
                            </div>
                            <div class="flex flex-col items-center">
                                <p>WED</p>
                                <i data-lucide="cloud" class="w-6 h-6 my-1"></i>
                                <p>29¬∞C</p>
                                <p class="text-gray-400">18¬∞C</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column -->
                <div class="lg:col-span-2 flex flex-col gap-6">

                    <!-- Guided Meditation -->
                    <div class="widget">
                         <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl flex items-center gap-2"><i data-lucide="brain-circuit" class="w-5 h-5"></i> Guided Meditation</h2>
                            <div class="flex items-center gap-2">
                                <button id="clear-meditation-btn" title="Clear Meditation" class="text-gray-400 hover:text-white"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                <button id="toggle-meditation-btn" title="Minimize" class="text-gray-400 hover:text-white"><i data-lucide="chevron-up" class="w-5 h-5"></i></button>
                            </div>
                        </div>
                        <div id="meditation-widget-body">
                            <p class="text-gray-400 mb-3 text-base">Enter a topic and select a language for your guided meditation.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                <input type="text" id="meditation-topic-input" placeholder="e.g., Releasing anxiety" class="bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-green-400 text-base">
                                <select id="meditation-language-select" class="bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-green-400 text-base">
                                    <option value="English (India)">English (India)</option>
                                    <option value="Hindi">Hindi</option>
                                    <option value="Bengali">Bengali</option>
                                    <option value="Tamil">Tamil</option>
                                    <option value="Telugu">Telugu</option>
                                    <option value="Marathi">Marathi</option>
                                    <option value="other">Other...</option>
                                </select>
                            </div>
                            <input type="text" id="meditation-language-search" placeholder="Enter language name (e.g., French)" class="hidden w-full bg-[#2E3338] p-2 mt-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-green-400 text-base">
                            <div class="flex gap-2 mt-2">
                            <button id="generate-meditation-btn" class="w-full bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Generate Script</button>
                            <button id="play-meditation-btn" class="w-full bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" disabled>Play Meditation</button>
                            </div>
                            <div id="meditation-script-container" class="gemini-response hidden mt-3 max-h-48 overflow-y-auto"></div>
                            <audio id="meditation-audio-player" class="w-full mt-3 hidden"></audio>
                        </div>
                    </div>

                    <!-- Serenity Map -->
                    <div class="widget">
                         <h2 class="text-xl mb-3 flex items-center gap-2"><i data-lucide="map" class="w-5 h-5"></i> Serenity Map</h2>
                         <div class="flex gap-2 mb-3">
                            <input type="text" id="location-search-input" placeholder="Search any location in India..." class="w-full bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-green-400 text-base">
                            <button id="location-search-btn" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Search</button>
                         </div>
                         <div id="map" class="w-full h-64 bg-[#2E3338] rounded"></div>
                    </div>
                    
                    <!-- Assignments -->
                    <div class="widget">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl flex items-center gap-2"><i data-lucide="clipboard-check"
                                    class="w-5 h-5"></i> assignments</h2>
                            <div class="flex items-center gap-2 text-sm text-gray-400">
                                <span>Local</span>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="storage-toggle" class="sr-only peer">
                                    <div
                                        class="w-11 h-6 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500">
                                    </div>
                                </label>
                                <span>Server</span>
                                <button id="sync-assignments-btn" class="ml-2 text-sm text-cyan-400 hover:text-cyan-300 hidden">Sync to Server</button>
                            </div>
                        </div>

                        <div id="assignments-list" class="space-y-2">
                            <div
                                class="grid grid-cols-[auto,1fr,auto,auto,auto] gap-x-4 items-center text-sm text-gray-400 pb-1 border-b border-gray-600">
                                <span></span>
                                <span>Name</span>
                                <span>Course</span>
                                <span>Due Date</span>
                                <span></span>
                            </div>
                            <!-- Dynamic tasks will be inserted here -->
                        </div>
                        <form id="new-assignment-form" class="mt-4 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-2 text-base">
                                <input type="text" id="new-assignment-name" placeholder="Task Name"
                                    class="bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-green-400"
                                    required>
                                <input type="text" id="new-assignment-course" placeholder="Course"
                                    class="bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-green-400">
                                <input type="date" id="new-assignment-due-date"
                                    class="bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-green-400">
                            </div>
                            <div class="flex justify-end gap-2 mt-2">
                                <button type="button" id="cancel-assignment-btn"
                                    class="text-sm text-gray-400 hover:text-white px-3 py-1 rounded">Cancel</button>
                                <button type="submit"
                                    class="text-sm bg-green-500/80 text-white px-3 py-1 rounded hover:bg-green-600">Add
                                    Task</button>
                            </div>
                        </form>
                        <button id="new-assignment-btn"
                            class="mt-4 text-gray-400 hover:text-white flex items-center gap-2"><i data-lucide="plus"
                                class="w-4 h-4"></i> New</button>
                    </div>

                    <!-- Music Player -->
                    <div class="widget">
                        <div class="flex justify-between items-center mb-4">
                            <div class="flex items-center gap-3">
                                <i data-lucide="music-4" class="w-6 h-6 text-green-400"></i>
                                <div>
                                    <h3 class="text-lg">chill vibes</h3>
                                    <p class="text-sm text-gray-400">lo-fi beats</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button id="spotify-btn"
                                    class="text-sm bg-[#1DB954]/80 text-white px-3 py-1 rounded hover:bg-[#1DB954] transition-colors">Spotify</button>
                                <button id="yt-music-btn"
                                    class="text-sm bg-[#FF0000]/80 text-white px-3 py-1 rounded hover:bg-[#FF0000] transition-colors">YT
                                    Music</button>
                            </div>
                        </div>
                        <div id="music-player-container" class="w-full h-96 mt-2">
                            <!-- Music player content is managed by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Peer Chat Window -->
    <div id="chat-window"
        class="fixed bottom-8 right-16 w-full max-w-md bg-[#39414A] rounded-lg shadow-2xl border border-[#4A5568] hidden flex flex-col z-20"
        style="height: 500px;">
        <!-- Header -->
        <div class="flex justify-between items-center p-3 bg-[#2E3338] rounded-t-lg">
            <div class="flex items-center gap-2">
                <h3 id="chat-header-title" class="text-lg flex items-center gap-2"><i data-lucide="users"
                        class="w-5 h-5"></i> Chat Room</h3>
            </div>
            <div class="flex items-center gap-3">
                <button id="peer-chat-clear-btn" title="Clear chat locally" class="text-gray-400 hover:text-white">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
                <button id="chat-close-btn" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        <!-- Messages -->
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4">
            <!-- Messages from Firestore will be dynamically inserted here -->
        </div>
        <!-- Input -->
        <div class="p-3 border-t border-[#4A5568]">
            <div class="flex gap-2">
                <input type="text" id="chat-input" placeholder="Type your message..."
                    class="w-full bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-green-400 text-base">
                <button id="chat-send-btn"
                    class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 flex items-center justify-center">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- blossom AI Chatbot Icon -->
    <button id="ai-chat-toggle-btn"
        class="fixed bottom-8 right-8 bg-fuchsia-500 text-white p-4 rounded-full shadow-lg hover:bg-fuchsia-600 transition-transform hover:scale-110 z-30">
        <i data-lucide="flower-2" class="w-8 h-8"></i>
    </button>

    <!-- blossom AI Chat Window -->
    <div id="ai-chat-window"
        class="fixed bottom-24 right-8 w-full max-w-md bg-[#39414A] rounded-lg shadow-2xl border border-[#4A5568] hidden flex flex-col z-30"
        style="height: 500px;">
        <div class="flex justify-between items-center p-3 bg-[#2E3338] rounded-t-lg">
            <h3 class="text-lg flex items-center gap-2"><i data-lucide="flower-2" class="w-5 h-5 text-fuchsia-400"></i> blossom AI</h3>
            <div class="flex items-center gap-3">
                <select id="ai-personality-selector"
                    class="bg-[#39414A] text-sm rounded p-1 border border-[#4A5568] focus:outline-none text-white">
                    <option value="helpful">Helpful</option>
                    <option value="creative">Creative</option>
                    <option value="sarcastic">Sarcastic</option>
                </select>
                <button id="ai-chat-clear-btn" title="Clear chat history" class="text-gray-400 hover:text-white">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
                <button id="ai-chat-close-btn" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
        <div id="ai-chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4"></div>
        <div class="p-3 border-t border-[#4A5568]">
            <div class="flex gap-2">
                <input type="text" id="ai-chat-input" placeholder="Ask me anything..."
                    class="w-full bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-fuchsia-400 text-base">
                <button id="ai-chat-send-btn"
                    class="bg-fuchsia-500 text-white px-4 py-2 rounded hover:bg-fuchsia-600 flex items-center justify-center">
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </div>


    <!-- Emote Picker Modal -->
    <div id="emote-picker-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="widget p-6 rounded-lg max-w-sm w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl">Choose a new picture</h3>
                <button id="close-emote-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="emote-grid" class="grid grid-cols-4 gap-4 text-4xl text-center">
                <!-- Emotes will be populated by JS -->
            </div>
        </div>
    </div>

    <!-- SOS Sidebar -->
    <div id="sos-sidebar"
        class="fixed top-0 right-0 w-80 h-full bg-[#39414A]/80 backdrop-blur-lg border-l border-white/10 shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out">
        <div class="p-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl flex items-center gap-2"><i data-lucide="life-buoy" class="w-5 h-5"></i> Emergency
                    Support</h2>
                <button id="close-sos-sidebar" class="text-gray-400 hover:text-white"><i data-lucide="x"
                        class="w-6 h-6"></i></button>
            </div>
            <div class="space-y-3 text-lg">
                <a href="tel:14416" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors">
                    <i data-lucide="phone" class="w-5 h-5"></i>
                    <span>Tele MANAS: 14416</span>
                </a>
                <a href="tel:18005990019" class="flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors">
                    <i data-lucide="shield-half" class="w-5 h-5"></i>
                    <span>Vandrevala Fdn: 1800-599-0019</span>
                </a>
                <button id="quick-meditation-sos-btn" class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors">
                    <i data-lucide="sparkles" class="w-5 h-5"></i>
                    <span>Quick Meditation</span>
                </button>
                <button id="breathing-exercise-sos-btn" class="w-full text-left flex items-center gap-3 p-3 rounded-lg hover:bg-white/10 transition-colors">
                    <i data-lucide="wind" class="w-5 h-5"></i>
                    <span>Breathing Exercise</span>
                </button>
                 <!-- START OF ADDED OFFLINE COPING KIT SECTION -->
                <div class="pt-4 mt-4 border-t border-white/10">
                    <div class="flex justify-between items-center mb-3">
                         <h3 class="text-lg flex items-center gap-2"><i data-lucide="package-check" class="w-5 h-5"></i> Offline Coping Kit</h3>
                    </div>
                    <div class="relative">
                        <div class="gradient-button-container w-full">
                            <button id="download-all-btn" class="w-full bg-black text-white p-3 rounded-lg flex items-center justify-between text-base">
                                <span>Download All (.zip)</span>
                            </button>
                            <button id="coping-kit-dropdown-btn" class="absolute right-0 top-0 h-full px-3 flex items-center">
                                <i data-lucide="chevron-down" class="w-5 h-5 transition-transform"></i>
                            </button>
                        </div>
                        <div id="coping-kit-dropdown" class="hidden absolute top-full right-0 mt-2 w-60 bg-[#2E3338] border border-white/10 rounded-lg shadow-lg z-10 text-base overflow-hidden">
                            <a href="#" id="download-contacts-btn" class="coping-kit-item">Emergency Contacts (.txt)</a>
                            <a href="#" id="download-exercises-btn" class="coping-kit-item">Calming Exercises (.txt)</a>
                            <a href="#" id="download-affirmations-btn" class="coping-kit-item">Positive Affirmations (.txt)</a>
                            <a href="#" id="download-journal-prompts-btn" class="coping-kit-item">5-Min Journal Prompts (.txt)</a>
                            <a href="#" id="download-hope-card-btn" class="coping-kit-item">Digital Hope Card (.png)</a>
                            <a href="#" id="download-mandala-btn" class="coping-kit-item">Mindfulness Mandala (.png)</a>
                        </div>
                    </div>
                </div>
                <!-- END OF ADDED OFFLINE COPING KIT SECTION -->
            </div>
        </div>
    </div>

   


    <!-- Journal Analysis Modal -->
    <div id="journal-analysis-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="widget p-6 rounded-lg max-w-xl w-full">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl flex items-center gap-2"><i data-lucide="brain-circuit" class="w-5 h-5"></i> AI
                    Journal Analysis</h3>
                <button id="close-journal-analysis-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="journal-analysis-content" class="gemini-response max-h-[60vh] overflow-y-auto">
                <!-- AI analysis will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Study Help Modal -->
    <div id="study-help-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center hidden z-50">
        <div class="widget p-6 rounded-lg max-w-lg w-full flex flex-col" style="height: 70vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl flex items-center gap-2"><i data-lucide="graduation-cap"
                        class="w-5 h-5 text-yellow-400"></i> Study Help !!</h3>
                <button id="close-study-help-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="study-upload-view" class="space-y-3 text-base">
                <p class="text-sm text-gray-400">Upload a document (PDF, TXT) to start a chat session.</p>
                <label for="study-file-upload"
                    class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed rounded-lg cursor-pointer bg-[#2E3338] border-gray-600 hover:border-gray-500 hover:bg-[#39414A]">
                    <div class="flex flex-col items-center justify-center pt-5 pb-6">
                        <i data-lucide="upload-cloud" class="w-10 h-10 mb-2 text-gray-400"></i>
                        <p class="mb-1 text-sm text-gray-400"><span class="font-semibold">Click to upload</span></p>
                        <p id="study-file-name" class="text-xs text-gray-400">PDF, TXT, MD, etc. (MAX. 5MB)</p>
                    </div>
                    <input id="study-file-upload" type="file" class="hidden" accept=".pdf, .txt, .md, .csv, text/plain, application/pdf" />
                </label>
            </div>
            <div id="study-chat-view" class="hidden flex-1 flex flex-col min-h-0">
                <div class="flex justify-between items-center p-2 bg-black/20 rounded mb-2">
                    <p id="study-chat-file-name" class="text-sm truncate text-gray-300"></p>
                    <button id="study-end-chat-btn" class="text-xs text-red-400 hover:text-white">End Session</button>
                </div>
                <div id="study-chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 bg-black/10 rounded">
                    <!-- Study chat messages will appear here -->
                </div>
                <div class="p-3 border-t border-[#4A5568] mt-2">
                    <div class="flex gap-2">
                        <input type="text" id="study-chat-input" placeholder="Ask a question about the document..."
                            class="w-full bg-[#2E3338] p-2 rounded border border-[#4A5568] focus:outline-none focus:ring-2 focus:ring-yellow-400 text-base">
                        <button id="study-chat-send-btn"
                            class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600 flex items-center justify-center">
                            <i data-lucide="send" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- START OF ADDED MENTAL HEALTH SCREENING MODAL -->
    <div id="screening-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="widget p-6 rounded-lg max-w-2xl w-full flex flex-col" style="max-height: 90vh;">
            <div class="flex justify-between items-center mb-4">
                <h3 id="screening-title" class="text-xl flex items-center gap-2"><i data-lucide="clipboard-check" class="w-5 h-5 text-green-400"></i> Mental Health Screening</h3>
                <button id="close-screening-modal" class="text-gray-400 hover:text-white">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="screening-questions-container" class="flex-1 overflow-y-auto pr-2 space-y-4 text-base">
                <!-- PHQ-9 and GAD-7 questions will be injected here by JS -->
            </div>
            <div class="mt-4 pt-4 border-t border-gray-600 flex justify-end">
                <button id="submit-screening-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors">Submit</button>
            </div>
        </div>
    </div>
    <!-- END OF ADDED MENTAL HEALTH SCREENING MODAL -->


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, serverTimestamp, doc, updateDoc, deleteDoc, getDocs, where, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- PDF.js Import ---
        import * as pdfjsLib from "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.min.mjs";
        pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.4.168/pdf.worker.min.mjs";
        
        // --- START OF FIX: Removed incorrect JSZip module import ---
        // import JSZip from "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
        // --- END OF FIX ---

        // --- IMPORTANT: ACTION REQUIRED ---
        const GIPHY_API_KEY = 'D25UbHQ9ZhdSwlwPPLWcc3WUXbS8vzd0';
        // START OF EDIT: Defined GIPHY_GIF_IDS globally
        const GIPHY_GIF_IDS = [ 'HRXnPYf10Zx0wz4alF', '6705G9I9sUcNCaJF10', 'rzeWnbH8Uc5Y4', 'TRebCjNbc4dIA', 'Basrh159dGwKY' ];
        // END OF EDIT
        const SPOTIFY_CLIENT_ID = '974fb988050a4b52a8dac1b812c8a9e4';
        const YT_MUSIC_CLIENT_ID = '186638354534-sc0ecemspj32eqkqk3u67ma2fe87gfnj.apps.googleusercontent.com';
        const GOOGLE_FIT_CLIENT_ID = '691627541266-nup7p5ked390epqje1vbh4eova6d7lpc.apps.googleusercontent.com';
        const YOUTUBE_API_KEY = 'AIzaSyC4isDfYT5JO64BtH1lvBP0-etVBXhAThA';
        const GEMINI_API_KEY = "AIzaSyBmGIl87H7xbIAOBRqg_FlXiiGYL1for0Q";

        // --- END OF ACTION REQUIRED ---

        // --- Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyCOveO-NFW_X5FkINfh5KMgCBBMlOej8M4",
            authDomain: "student-dashboard-4ec02.firebaseapp.com",
            projectId: "student-dashboard-4ec02",
            storageBucket: "student-dashboard-4ec02.firebasestorage.app",
            messagingSenderId: "250478137189",
            appId: "1:250478137189:web:224352f8e017b4194edb8c",
            measurementId: "G-K159S6DZNP"
        };
        const finalFirebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const sanitizedAppId = appId.replace(/\//g, '_');

        let db, auth, currentUserId, currentUserAnonymousName;
        let unsubscribeFromNotifications = null;
        let aiChatHistory = [];
        let currentChatRoomId = null;
        let unsubscribeFromMessages = null;
        let assignmentStorageMode = localStorage.getItem('assignmentStorageMode') || 'server';
        let unsubscribeFromAssignments = null;
        let journalStorageMode = localStorage.getItem('journalStorageMode') || 'server';
        let unsubscribeFromJournal = null;

        
        // --- DOM Element Declarations ---
        const notificationBanner = document.getElementById('notification-banner');
        const notificationMessage = document.getElementById('notification-message');
        const coverElement = document.querySelector('.pixelated-bg');
        const chatWindow = document.getElementById('chat-window');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const peerChatClearBtn = document.getElementById('peer-chat-clear-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const chatSendBtn = document.getElementById('chat-send-btn');
        const chatHeaderTitle = document.getElementById('chat-header-title');
        const aiChatToggleBtn = document.getElementById('ai-chat-toggle-btn');
        const aiChatWindow = document.getElementById('ai-chat-window');
        const aiChatCloseBtn = document.getElementById('ai-chat-close-btn');
        const aiChatClearBtn = document.getElementById('ai-chat-clear-btn');
        const aiChatMessages = document.getElementById('ai-chat-messages');
        const aiChatInput = document.getElementById('ai-chat-input');
        const aiChatSendBtn = document.getElementById('ai-chat-send-btn');
        const aiPersonalitySelector = document.getElementById('ai-personality-selector');
        const assignmentsList = document.getElementById('assignments-list');
        const newAssignmentBtn = document.getElementById('new-assignment-btn');
        const newAssignmentForm = document.getElementById('new-assignment-form');
        const cancelAssignmentBtn = document.getElementById('cancel-assignment-btn');
        const storageToggle = document.getElementById('storage-toggle');
        const helpfulLinkBtn = document.getElementById('helpful-link-btn');
        const helpfulLinksList = document.getElementById('helpful-links-list');

        
        // --- START OF FIX: All function definitions are moved here, before any execution logic ---
        
        // --- Utility Functions ---
        function showNotification(message, type = 'success') {
            notificationMessage.textContent = message;
            notificationBanner.classList.remove('bg-green-500', 'bg-red-500', 'bg-orange-600', 'bg-blue-500', 'hidden');
            
            if (type === 'success') {
                notificationBanner.classList.add('bg-green-500');
            } else if (type === 'error') {
                notificationBanner.classList.add('bg-red-500');
            } else if (type === 'info') {
                notificationBanner.classList.add('bg-blue-500');
            } else { 
                notificationBanner.classList.add('bg-orange-600');
            }

            notificationBanner.classList.remove('hidden');
            setTimeout(() => {
                notificationBanner.classList.add('hidden');
            }, 5000);
        }

        function generateAnonymousName() {
            const adjectives = ["Brave", "Silent", "Wise", "Wandering", "Gentle", "Hidden", "Cosmic", "Lunar", "Solar", "Pixelated"];
            const nouns = ["River", "Fox", "Oak", "Badger", "Starlight", "Meadow", "Whisper", "Dreamer", "Voyager", "Sprite"];
            const adjective = adjectives[Math.floor(Math.random() * adjectives.length)];
            const noun = nouns[Math.floor(Math.random() * nouns.length)];
            return `${adjective} ${noun}`;
        }

        // --- Gemini API Integration ---
        async function getGeminiResponse(prompt, customSystemInstruction = null) {
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent`;
            const defaultSystemInstruction = "You are a helpful assistant. Important: You must not provide any medical, clinical, or therapeutic advice. Your goal is to be supportive and provide general information or creative ideas. If the user seems to be in distress or asks for advice related to health or mental well-being, you must gently decline and suggest they consult a qualified professional.";
            try {
                 if (!GEMINI_API_KEY || GEMINI_API_KEY.includes('YOUR_')) {
                    return "Sorry, the AI Assistant is not configured. Please add a Gemini API Key in the code.";
                }
                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    systemInstruction: { parts: [{ text: customSystemInstruction || defaultSystemInstruction }] },
                };
                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    const errorMessage = errorData?.error?.message || response.statusText;
                    throw new Error(`API error (${response.status}): ${errorMessage}`);
                }
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "No response found.";
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return `Sorry, something went wrong. Please check the console for details. Error: ${error.message}`;
            }
        }

        // --- Page Setup and Initialization Functions ---
        async function fetchAndSetCoverGif(apiKey, gifIds) {
            const ids = gifIds.join(',');
            const url = `https://api.giphy.com/v1/gifs?api_key=${apiKey}&ids=${ids}`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Giphy API error: ${response.statusText}`);
                const data = await response.json();
                if (data.data && data.data.length > 0) {
                    const randomIndex = Math.floor(Math.random() * data.data.length);
                    coverElement.style.backgroundImage = `url('${data.data[randomIndex].images.original.url}')`;
                }
            } catch (error) {
                console.error("Failed to fetch GIFs from Giphy:", error);
                coverElement.style.backgroundImage = `url('https://placehold.co/1200x200/5B6F55/C2C2C2?text=Invalid+Giphy+Key')`;
            }
        }

        function initializePage() {
            if (GIPHY_API_KEY.includes('YOUR_')) {
                coverElement.style.backgroundImage = `url('https://placehold.co/1200x200/5B6F55/C2C2C2?text=Add+Giphy+Key+in+Code')`;
            } else {
                fetchAndSetCoverGif(GIPHY_API_KEY, GIPHY_GIF_IDS);
            }
        }
        
        // --- Content Flagging ---
        async function checkForSuicidalIntent(text) {
            const prompt = `Analyze the following text for suicidal intent. Respond with only "YES" if it contains clear suicidal ideation, plans, or intent, and "NO" otherwise. Text: "${text}"`;
            const systemInstruction = "You are a content safety classifier. Your only job is to detect suicidal intent. You must only respond with 'YES' or 'NO'.";
            
            const response = await getGeminiResponse(prompt, systemInstruction);
            if (response.trim().toUpperCase().includes('YES')) {
                await flagUserContent(text);
            }
        }

        async function flagUserContent(message) {
            if (!db || !currentUserId) {
                throw new Error("User not authenticated. Cannot flag content.");
            }
            try {
                const flaggedUsersRef = collection(db, `artifacts/${sanitizedAppId}/public/data/flagged_users`);
                await addDoc(flaggedUsersRef, {
                    userId: currentUserId,
                    message: message,
                    timestamp: serverTimestamp()
                });
                console.warn(`User content flagged for user: ${currentUserId}`);

                const banner = document.getElementById('notification-banner');
                const messageEl = document.getElementById('notification-message');

                messageEl.innerHTML = `It looks like you're going through a tough time. Help is available. <button id="notification-sos-btn" class="font-bold underline hover:text-yellow-200 ml-2">Open Support Panel</button>`;
                
                banner.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
                banner.classList.add('bg-orange-600'); 

                document.getElementById('notification-sos-btn').addEventListener('click', () => {
                    document.getElementById('sos-sidebar').classList.remove('translate-x-full');
                });
                
            } catch (error) {
                console.error("Could not flag user content:", error);
                throw new Error("Could not send alert to administrators.");
            }
        }
        
        // --- Notifications ---
        function initializeNotifications() {
            const notificationBellBtn = document.getElementById('notification-bell-btn');
            const notificationBadge = document.getElementById('notification-badge');
            const notificationPanel = document.getElementById('notification-panel');
            const notificationList = document.getElementById('notification-list');
            
            let isInitialNotificationLoad = true;

            notificationBellBtn.addEventListener('click', () => {
                notificationPanel.classList.toggle('hidden');
                if (!notificationPanel.classList.contains('hidden')) {
                    markNotificationsAsRead();
                }
            });

            if (!db || !currentUserId) { return; }

            const notificationsRef = collection(db, `artifacts/${sanitizedAppId}/users/${currentUserId}/notifications`);
            const q = query(notificationsRef);
            
            unsubscribeFromNotifications = onSnapshot(q, (snapshot) => {
                const notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                notifications.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                notificationList.innerHTML = '';
                let unreadCount = 0;

                if (notifications.length === 0) {
                    notificationList.innerHTML = `<p class="p-4 text-center text-sm text-gray-400">You have no new messages.</p>`;
                } else {
                     notifications.forEach(notif => {
                        if (!notif.read) unreadCount++;
                        renderNotificationItem(notif);
                    });
                }

                if (unreadCount > 0) {
                    notificationBadge.textContent = unreadCount;
                    notificationBadge.classList.remove('hidden');
                } else {
                    notificationBadge.classList.add('hidden');
                }
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added" && !isInitialNotificationLoad) {
                         const newNotif = change.doc.data();
                         if (newNotif.type === 'screening_reminder') {
                            showNotification(`A friendly reminder: ${newNotif.message}`, 'info');
                         }
                    }
                });
                isInitialNotificationLoad = false;
            });

            function renderNotificationItem(notif) {
                const item = document.createElement('div');
                item.className = `p-3 border-b border-white/5 ${!notif.read ? 'bg-blue-500/10' : ''}`;
                const timestamp = notif.createdAt?.toDate ? notif.createdAt.toDate().toLocaleDateString() : 'Just now';
                item.innerHTML = `
                    <p class="font-bold text-base flex items-center gap-2"><i data-lucide="message-square" class="w-4 h-4 text-blue-400"></i>${notif.title}</p>
                    <p class="text-sm text-gray-300 pl-6">${notif.message}</p>
                    <p class="text-xs text-right text-gray-500 mt-1">${timestamp}</p>
                `;
                notificationList.appendChild(item);
                lucide.createIcons();
            }
            
            async function markNotificationsAsRead() {
                const qUnread = query(notificationsRef, where("read", "==", false));
                const snapshot = await getDocs(qUnread);
                snapshot.forEach(docToUpdate => {
                    updateDoc(docToUpdate.ref, { read: true });
                });
            }
        }
        
        // --- Guided Meditation ---
        function initializeMeditationWidget() {
            const topicInput = document.getElementById('meditation-topic-input');
            const languageSelect = document.getElementById('meditation-language-select');
            const languageSearch = document.getElementById('meditation-language-search');
            const generateBtn = document.getElementById('generate-meditation-btn');
            const playBtn = document.getElementById('play-meditation-btn');
            const scriptContainer = document.getElementById('meditation-script-container');
            const audioPlayer = document.getElementById('meditation-audio-player');
            const quickMeditationBtn = document.getElementById('quick-meditation-sos-btn');
            const breathingExerciseBtn = document.getElementById('breathing-exercise-sos-btn');
            const clearBtn = document.getElementById('clear-meditation-btn');
            const toggleBtn = document.getElementById('toggle-meditation-btn');
            const meditationBody = document.getElementById('meditation-widget-body');

            let lastUsedLanguage = localStorage.getItem('lastMeditationLanguage') || 'English (India)';

            function setInitialLanguage() {
                const options = Array.from(languageSelect.options).map(opt => opt.value);
                if (options.includes(lastUsedLanguage)) {
                    languageSelect.value = lastUsedLanguage;
                } else {
                    languageSelect.value = 'other';
                    languageSearch.classList.remove('hidden');
                    languageSearch.value = lastUsedLanguage;
                }
            }

            languageSelect.addEventListener('change', () => {
                languageSearch.classList.toggle('hidden', languageSelect.value !== 'other');
            });

            async function generateScript() {
                const topic = topicInput.value.trim();
                let language = languageSelect.value === 'other' ? languageSearch.value.trim() : languageSelect.value;
                if (!topic || !language) {
                    showNotification("Please provide a topic and language.", "error");
                    return;
                }
                localStorage.setItem('lastMeditationLanguage', language);
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<div class="loader" style="width:20px; height:20px; border-width: 2px; margin: auto;"></div>';
                scriptContainer.classList.remove('hidden');
                scriptContainer.innerHTML = '<div class="loader"></div>';
                playBtn.disabled = true;
                audioPlayer.classList.add('hidden');
                const prompt = `Generate a short (around 150 words), calming guided meditation script in the ${language} language about "${topic}". The script should be easy to follow and soothing.`;
                const systemInstruction = "You are a meditation guide. You create peaceful and serene meditation scripts. Do not include any introductory or concluding remarks outside of the script itself.";
                const script = await getGeminiResponse(prompt, systemInstruction);
                scriptContainer.textContent = script;
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'Generate Script';
                playBtn.disabled = false;
            }

            async function playAudio() {
                const script = scriptContainer.textContent;
                if (!script) {
                    showNotification("Please generate a script first.", "error");
                    return;
                }
                playBtn.disabled = true;
                playBtn.innerHTML = '<div class="loader" style="width:20px; height:20px; border-width: 2px; margin: auto;"></div>';
                const ttsPrompt = `Say in a calm, slow, and soothing voice: ${script}`;
                try {
                    const audioData = await fetchTTS(ttsPrompt);
                    if (audioData) {
                        const pcmData = base64ToArrayBuffer(audioData);
                        const pcm16 = new Int16Array(pcmData);
                        const wavBlob = pcmToWav(pcm16, 24000);
                        const audioUrl = URL.createObjectURL(wavBlob);
                        audioPlayer.src = audioUrl;
                        audioPlayer.controls = true;
                        audioPlayer.classList.remove('hidden');
                        audioPlayer.play();
                    } else {
                        showNotification("Could not generate audio. Please try again.", "error");
                    }
                } catch (error) {
                     showNotification("An error occurred while generating audio.", "error");
                     console.error("TTS Error:", error);
                } finally {
                    playBtn.disabled = false;
                    playBtn.innerHTML = 'Play Meditation';
                }
            }
            
            async function fetchTTS(prompt) {
                const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${GEMINI_API_KEY}`;
                const payload = {
                    model: "gemini-2.5-flash-preview-tts",
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { responseModalities: ["AUDIO"] },
                };
                try {
                    const response = await fetch(TTS_API_URL, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    return result.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                } catch (error) {
                    console.error("Error calling TTS API:", error);
                    return null;
                }
            }
            
            function base64ToArrayBuffer(base64) {
                const binaryString = window.atob(base64);
                const len = binaryString.length;
                const bytes = new Uint8Array(len);
                for (let i = 0; i < len; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }

            function pcmToWav(pcmData, sampleRate) {
                const numChannels = 1;
                const bitsPerSample = 16;
                const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
                const blockAlign = numChannels * (bitsPerSample / 8);
                const dataSize = pcmData.length * (bitsPerSample / 8);
                const fileSize = 36 + dataSize;
                const buffer = new ArrayBuffer(44 + dataSize);
                const view = new DataView(buffer);
                function writeString(view, offset, string) {
                    for (let i = 0; i < string.length; i++) {
                        view.setUint8(offset + i, string.charCodeAt(i));
                    }
                }
                writeString(view, 0, 'RIFF');
                view.setUint32(4, fileSize, true);
                writeString(view, 8, 'WAVE');
                writeString(view, 12, 'fmt ');
                view.setUint32(16, 16, true); 
                view.setUint16(20, 1, true); 
                view.setUint16(22, numChannels, true);
                view.setUint32(24, sampleRate, true);
                view.setUint32(28, byteRate, true);
                view.setUint16(32, blockAlign, true);
                view.setUint16(34, bitsPerSample, true);
                writeString(view, 36, 'data');
                view.setUint32(40, dataSize, true);
                for (let i = 0; i < pcmData.length; i++) {
                    view.setInt16(44 + i * 2, pcmData[i], true);
                }
                return new Blob([view], { type: 'audio/wav' });
            }
            
            toggleBtn.addEventListener('click', () => {
                meditationBody.classList.toggle('hidden');
                toggleBtn.innerHTML = meditationBody.classList.contains('hidden') ? '<i data-lucide="chevron-down" class="w-5 h-5"></i>' : '<i data-lucide="chevron-up" class="w-5 h-5"></i>';
                toggleBtn.title = meditationBody.classList.contains('hidden') ? "Expand" : "Minimize";
                lucide.createIcons();
            });

            clearBtn.addEventListener('click', () => {
                topicInput.value = '';
                scriptContainer.textContent = '';
                scriptContainer.classList.add('hidden');
                audioPlayer.src = '';
                audioPlayer.classList.add('hidden');
                playBtn.disabled = true;
            });

            quickMeditationBtn.addEventListener('click', () => {
                topicInput.value = "5-minute calming meditation";
                setInitialLanguage();
                generateScript();
                document.getElementById('sos-sidebar').classList.add('translate-x-full');
            });

            breathingExerciseBtn.addEventListener('click', () => {
                topicInput.value = "Guided box breathing exercise for focus";
                setInitialLanguage();
                generateScript();
                document.getElementById('sos-sidebar').classList.add('translate-x-full');
            });
            
            generateBtn.addEventListener('click', generateScript);
            playBtn.addEventListener('click', playAudio);
            setInitialLanguage();
        }

        // --- Peer Chat ---
        function initializePeerChat() {
            const chatroomBtns = document.querySelectorAll('.chatroom-btn');
            chatroomBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    aiChatWindow.classList.add('hidden');
                    joinChatRoom(btn.dataset.roomName);
                });
            });
            chatCloseBtn.addEventListener('click', () => {
                chatWindow.classList.add('hidden');
                if (unsubscribeFromMessages) {
                    unsubscribeFromMessages();
                    unsubscribeFromMessages = null;
                }
                currentChatRoomId = null;
            });
            peerChatClearBtn.addEventListener('click', () => {
                if (currentChatRoomId) {
                    localStorage.setItem(`chatClearTimestamp_${currentChatRoomId}`, new Date().toISOString());
                    chatMessages.innerHTML = '';
                }
            });
            chatSendBtn.addEventListener('click', handlePeerSendMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handlePeerSendMessage();
            });
        }

        function joinChatRoom(roomId) {
            if (unsubscribeFromMessages) unsubscribeFromMessages();
            if (!currentUserId) {
                chatHeaderTitle.innerHTML = `<i data-lucide="loader" class="w-5 h-5 animate-spin"></i> Connecting...`;
                chatMessages.innerHTML = `<div class="p-4 text-center text-gray-400">Please wait for connection, then rejoin the room.</div>`;
                chatWindow.classList.remove('hidden');
                lucide.createIcons();
                return;
            }
            currentChatRoomId = roomId.replace(/\s+/g, '-').toLowerCase();
            chatHeaderTitle.innerHTML = `<i data-lucide="users" class="w-5 h-5"></i> ${roomId}`;
            chatMessages.innerHTML = '';
            chatWindow.classList.remove('hidden');
            lucide.createIcons();
            if (!db) {
                chatMessages.innerHTML = '<div>Error: Chat database not connected.</div>';
                return;
            }
            const clearTimestamp = localStorage.getItem(`chatClearTimestamp_${currentChatRoomId}`);
            const messagesRef = collection(db, `artifacts/${sanitizedAppId}/public/data/chatrooms/${currentChatRoomId}/messages`);
            const q = query(messagesRef);
            unsubscribeFromMessages = onSnapshot(q, (snapshot) => {
                const messages = snapshot.docs.map(doc => doc.data());
                messages.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
                chatMessages.innerHTML = ''; 
                messages.forEach(messageData => {
                    const messageTimestamp = messageData.createdAt?.toDate();
                    if (clearTimestamp && messageTimestamp && messageTimestamp < new Date(clearTimestamp)) return; 
                    displayPeerChatMessage(messageData);
                });
            }, (error) => {
                console.error("Error listening to chat messages:", error);
                chatMessages.innerHTML = '<div>Error loading messages. Please check permissions.</div>';
            });
        }

        function displayPeerChatMessage(messageData) {
            const isCurrentUser = messageData.senderId === currentUserId;
            const messageContainer = document.createElement('div');
            messageContainer.className = `chat-message ${isCurrentUser ? 'user' : 'other'}`;
            const senderIdText = isCurrentUser ? 'You' : messageData.senderName || `User ${messageData.senderId.substring(0, 6)}...`;
            const senderIdTitle = isCurrentUser ? `You (${currentUserAnonymousName})` : `${messageData.senderName} (${messageData.senderId})`;
            messageContainer.innerHTML = `
                <div class="flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'}">
                    <div class="chat-sender-id" title="${senderIdTitle}">${senderIdText}</div>
                    <div class="chat-bubble ${isCurrentUser ? 'user' : 'other-user'}">${messageData.text}</div>
                </div>
            `;
            chatMessages.appendChild(messageContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function handlePeerSendMessage() {
            const userInput = chatInput.value.trim();
            if (!userInput || !currentChatRoomId || !currentUserId || !db) return;
            try {
                await checkForSuicidalIntent(userInput);
                const messagesRef = collection(db, `artifacts/${sanitizedAppId}/public/data/chatrooms/${currentChatRoomId}/messages`);
                await addDoc(messagesRef, {
                    text: userInput,
                    senderId: currentUserId,
                    senderName: currentUserAnonymousName,
                    createdAt: serverTimestamp()
                });
                chatInput.value = '';
            } catch (error) {
                console.error("Error sending message or flagging content:", error);
                showNotification("Your message could not be sent due to a safety check error.", "error");
            }
        }

        // --- AI Chatbot ---
        async function getGeminiResponseWithPersonality(prompt, history, personality) {
            const personalityPrompts = {
                helpful: "You are a helpful and friendly assistant named blossom AI. You are concise and to the point. You are here to help the user with their tasks. Important: You must not provide any medical, clinical, or therapeutic advice. If the user asks for this type of advice, you must gently decline and suggest they consult a qualified professional.",
                creative: "You are a creative muse named blossom AI. You think outside the box and provide imaginative and inspiring ideas. You speak in a poetic and slightly eccentric way. Important: You must not provide any medical, clinical, or therapeutic advice. If the user asks for this type of advice, you must gently decline and suggest they consult a qualified professional.",
                sarcastic: "You are a sarcastic, witty bot named blossom AI. You answer questions correctly but with a dry sense of humor and a bit of sass. You're not mean, just amusingly unimpressed. Important: You must not provide any medical, clinical, or therapeutic advice. If the user asks for this type of advice, you must gently decline and suggest they consult a qualified professional."
            };
            const systemPrompt = personalityPrompts[personality] || personalityPrompts['helpful'];
            const contents = history.map(msg => ({
                role: msg.sender === 'user' ? 'user' : 'model',
                parts: [{ text: msg.text }]
            }));
            contents.push({ role: 'user', parts: [{ text: prompt }] });
            return await getGeminiResponse(prompt, systemPrompt);
        }

        function displayAiChatMessage(text, sender, save = true) {
            const messageContainer = document.createElement('div');
            messageContainer.className = `chat-message ${sender}`;
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender}`;
            bubble.textContent = text;
            messageContainer.appendChild(bubble);
            aiChatMessages.appendChild(messageContainer);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
            if (save) {
                aiChatHistory.push({ sender, text });
                localStorage.setItem('aiChatHistory', JSON.stringify(aiChatHistory));
            }
        }

        async function handleAiSendMessage() {
            const userInput = aiChatInput.value.trim();
            if (!userInput) return;
            aiChatSendBtn.disabled = true;
            aiChatInput.value = '';
            displayAiChatMessage(userInput, 'user');
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'ai-typing-indicator';
            typingIndicator.className = 'chat-message ai';
            typingIndicator.innerHTML = `<div class="chat-bubble ai"><div class="loader" style="width:20px; height:20px; margin:0;"></div></div>`;
            aiChatMessages.appendChild(typingIndicator);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
            try {
                await checkForSuicidalIntent(userInput);
                const personality = aiPersonalitySelector.value;
                const aiResponse = await getGeminiResponseWithPersonality(userInput, aiChatHistory, personality);
                typingIndicator.remove();
                displayAiChatMessage(aiResponse, 'ai');
            } catch (error) {
                console.error("Error sending AI message or flagging content:", error);
                showNotification("Your message could not be processed due to a safety check error.", "error");
                typingIndicator?.remove();
            } finally {
                aiChatSendBtn.disabled = false;
            }
        }

        function loadAiChatHistory() {
            const savedHistory = localStorage.getItem('aiChatHistory');
            if (savedHistory && JSON.parse(savedHistory).length > 0) {
                aiChatHistory = JSON.parse(savedHistory);
                aiChatMessages.innerHTML = '';
                aiChatHistory.forEach(msg => displayAiChatMessage(msg.text, msg.sender, false));
            } else {
                aiChatHistory = [];
                displayAiChatMessage("Hello! I'm blossom AI. How can I help you bloom today?", 'ai', false);
            }
        }

        function initializeAiChat() {
            aiChatToggleBtn.addEventListener('click', () => {
                aiChatWindow.classList.toggle('hidden');
                chatWindow.classList.add('hidden');
                lucide.createIcons();
            });
            aiChatCloseBtn.addEventListener('click', () => aiChatWindow.classList.add('hidden'));
            aiChatSendBtn.addEventListener('click', handleAiSendMessage);
            aiChatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAiSendMessage();
            });
            aiChatClearBtn.addEventListener('click', () => {
                aiChatHistory = [];
                localStorage.removeItem('aiChatHistory');
                aiChatMessages.innerHTML = '';
                displayAiChatMessage("Hello! I'm blossom AI. How can I help you bloom today?", 'ai', false);
            });
        }

        // --- Profile Picture ---
        function initializeProfilePic() {
            const profilePicContainer = document.getElementById('profile-pic-container');
            const emotePickerModal = document.getElementById('emote-picker-modal');
            const closeEmoteModalBtn = document.getElementById('close-emote-modal');
            const emoteGrid = document.getElementById('emote-grid');
            
            profilePicContainer.addEventListener('click', () => emotePickerModal.classList.remove('hidden'));
            closeEmoteModalBtn.addEventListener('click', () => emotePickerModal.classList.add('hidden'));
            emotePickerModal.addEventListener('click', (e) => { if (e.target === emotePickerModal) emotePickerModal.classList.add('hidden'); });
            
            emoteGrid.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const profilePicEmoji = document.getElementById('profile-pic-emoji');
                    const newEmote = e.target.textContent;
                    profilePicEmoji.textContent = newEmote;
                    localStorage.setItem('dashboardProfilePic', newEmote);
                    emotePickerModal.classList.add('hidden');
                }
            });
        }

        function populateEmotePicker() {
            const emoteGrid = document.getElementById('emote-grid');
            const availableEmotes = ['‚òòÔ∏è', 'üå∏', 'üçì', 'üçÑ', '‚ú®', 'üåô', 'ü™ê', 'ü¶ä', 'üê∏', 'üê¢', 'ü¶ã', '‚≠ê'];
            emoteGrid.innerHTML = '';
            availableEmotes.forEach(emote => {
                const button = document.createElement('button');
                button.className = 'p-2 rounded-lg hover:bg-white/10 transition-colors';
                button.textContent = emote;
                emoteGrid.appendChild(button);
            });
        }

        function loadProfilePic() {
            const profilePicEmoji = document.getElementById('profile-pic-emoji');
            const savedEmote = localStorage.getItem('dashboardProfilePic');
            if (savedEmote) profilePicEmoji.textContent = savedEmote;
        }

        // --- Assignments ---
        function clearAssignmentsList() {
            while (assignmentsList.children.length > 1) {
                assignmentsList.removeChild(assignmentsList.lastChild);
            }
        }

        function renderAssignment(data, id) {
            const item = document.createElement('div');
            item.className = `task-item grid grid-cols-[auto,1fr,auto,auto,auto] gap-x-4 items-center ${data.completed ? 'completed' : ''}`;
            item.dataset.id = id;
            item.innerHTML = `
                <input type="checkbox" class="task-checkbox" ${data.completed ? 'checked' : ''}>
                <span>${data.name}</span>
                <span class="course-tag" style="background-color: ${getCourseColor(data.course)}">${data.course || 'General'}</span>
                <span>${data.dueDate ? new Date(data.dueDate).toLocaleDateString() : 'No date'}</span>
                <button class="delete-assignment-btn text-gray-500 hover:text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
            `;
            assignmentsList.appendChild(item);
            lucide.createIcons();
        }

        function getCourseColor(course) {
            let hash = 0;
            for (let i = 0; i < (course || '').length; i++) {
                hash = course.charCodeAt(i) + ((hash << 5) - hash);
            }
            return `hsl(${hash % 360}, 50%, 60%)`;
        }

        function initializeAssignments() {
            clearAssignmentsList();
            if (unsubscribeFromAssignments) unsubscribeFromAssignments();
            const syncAssignmentsBtn = document.getElementById('sync-assignments-btn');
            if (assignmentStorageMode === 'server') {
                initializeFirestoreAssignments();
                syncAssignmentsBtn.classList.add('hidden');
            } else {
                initializeLocalAssignments();
                syncAssignmentsBtn.classList.remove('hidden');
            }
            storageToggle.checked = assignmentStorageMode === 'server';
        }

        function initializeFirestoreAssignments() {
            const user = auth.currentUser;
            if (!user) {
                assignmentsList.innerHTML += '<div class="text-center text-gray-400 p-4 col-span-full">Connecting...</div>';
                return;
            }
            const assignmentsRef = collection(db, `artifacts/${sanitizedAppId}/users/${user.uid}/assignments`);
            const q = query(assignmentsRef);
            unsubscribeFromAssignments = onSnapshot(q, (snapshot) => {
                clearAssignmentsList();
                const assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                assignments.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                assignments.forEach(assignment => renderAssignment(assignment, assignment.id));
            }, (error) => {
                console.error("Error getting assignments:", error);
                clearAssignmentsList();
                assignmentsList.innerHTML += '<div class="text-center text-red-400 p-4 col-span-full">Error loading assignments.</div>';
            });
        }

        function initializeLocalAssignments() {
            const localTasks = JSON.parse(localStorage.getItem('localAssignments')) || [];
            clearAssignmentsList();
            localTasks.forEach(task => renderAssignment(task, task.id));
        }
        
        function setupAssignmentEventListeners() {
            storageToggle.addEventListener('change', () => {
                assignmentStorageMode = storageToggle.checked ? 'server' : 'local';
                localStorage.setItem('assignmentStorageMode', assignmentStorageMode);
                initializeAssignments();
            });
            newAssignmentBtn.addEventListener('click', () => {
                newAssignmentForm.classList.remove('hidden');
                newAssignmentBtn.classList.add('hidden');
            });
            cancelAssignmentBtn.addEventListener('click', () => {
                newAssignmentForm.classList.add('hidden');
                newAssignmentBtn.classList.remove('hidden');
                newAssignmentForm.reset();
            });
            newAssignmentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('new-assignment-name').value.trim();
                const course = document.getElementById('new-assignment-course').value.trim();
                const dueDate = document.getElementById('new-assignment-due-date').value;
                if (!name) return;
                if (assignmentStorageMode === 'server') {
                    if (!db || !currentUserId) {
                         showNotification("Cannot save to server. Connection not ready.", "error");
                        return;
                    }
                    await addDoc(collection(db, `artifacts/${sanitizedAppId}/users/${currentUserId}/assignments`), {
                        name, course, dueDate, completed: false, createdAt: serverTimestamp()
                    });
                } else {
                    const localTasks = JSON.parse(localStorage.getItem('localAssignments')) || [];
                    const newTask = { id: Date.now().toString(), name, course, dueDate, completed: false, createdAt: new Date().toISOString() };
                    localTasks.push(newTask);
                    localStorage.setItem('localAssignments', JSON.stringify(localTasks));
                    initializeLocalAssignments();
                }
                newAssignmentForm.reset();
                newAssignmentForm.classList.add('hidden');
                newAssignmentBtn.classList.remove('hidden');
            });
            assignmentsList.addEventListener('click', async (e) => {
                const target = e.target;
                const taskItem = target.closest('.task-item');
                if (!taskItem) return;
                const id = taskItem.dataset.id;
                if (assignmentStorageMode === 'server') {
                     if (!db || !currentUserId) return;
                    const docRef = doc(db, `artifacts/${sanitizedAppId}/users/${currentUserId}/assignments`, id);
                    if (target.matches('.task-checkbox')) {
                        await updateDoc(docRef, { completed: target.checked });
                    }
                    if (target.closest('.delete-assignment-btn')) {
                        await deleteDoc(docRef);
                    }
                } else {
                    let localTasks = JSON.parse(localStorage.getItem('localAssignments')) || [];
                    if (target.matches('.task-checkbox')) {
                        localTasks.find(t => t.id === id).completed = target.checked;
                    }
                    if (target.closest('.delete-assignment-btn')) {
                        localTasks = localTasks.filter(t => t.id !== id);
                    }
                    localStorage.setItem('localAssignments', JSON.stringify(localTasks));
                    initializeLocalAssignments();
                }
            });
            document.getElementById('sync-assignments-btn').addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) { showNotification("Please wait for connection to sync.", "error"); return; }
                const syncBtn = document.getElementById('sync-assignments-btn');
                syncBtn.disabled = true;
                syncBtn.textContent = 'Syncing...';
                const localTasks = JSON.parse(localStorage.getItem('localAssignments')) || [];
                if (localTasks.length === 0) {
                    showNotification("No local assignments to sync.");
                } else {
                    try {
                        const assignmentsRef = collection(db, `artifacts/${sanitizedAppId}/users/${user.uid}/assignments`);
                        for (const task of localTasks) {
                            await addDoc(assignmentsRef, { name: task.name, course: task.course, dueDate: task.dueDate, completed: task.completed, createdAt: serverTimestamp() });
                        }
                        localStorage.removeItem('localAssignments');
                        assignmentStorageMode = 'server';
                        localStorage.setItem('assignmentStorageMode', assignmentStorageMode);
                        initializeAssignments(); 
                        showNotification("Local assignments synced successfully.");
                    } catch (error) {
                        console.error("Error syncing assignments:", error);
                        showNotification("An error occurred during sync.", "error");
                    }
                }
                syncBtn.disabled = false;
                syncBtn.textContent = 'Sync to Server';
            });
        }
       
        
        // --- Mental Health Screening ---
        function initializeMentalHealthScreening() {
            const startScreeningBtn = document.getElementById('start-screening-btn');
            const screeningModal = document.getElementById('screening-modal');
            const closeScreeningModalBtn = document.getElementById('close-screening-modal');
            const submitScreeningBtn = document.getElementById('submit-screening-btn');
            const verifiedBadge = document.getElementById('verified-badge');
            const phq9Questions = [ "Little interest or pleasure in doing things", "Feeling down, depressed, or hopeless", "Trouble falling or staying asleep, or sleeping too much", "Feeling tired or having little energy", "Poor appetite or overeating", "Feeling bad about yourself ‚Äî or that you are a failure or have let yourself or your family down", "Trouble concentrating on things, such as reading the newspaper or watching television", "Moving or speaking so slowly that other people could have noticed? Or the opposite ‚Äî being so fidgety or restless that you have been moving around a lot more than usual", "Thoughts that you would be better off dead or of hurting yourself in some way" ];
            const gad7Questions = [ "Feeling nervous, anxious, or on edge", "Not being able to stop or control worrying", "Worrying too much about different things", "Trouble relaxing", "Being so restless that it's hard to sit still", "Becoming easily annoyed or irritable", "Feeling afraid as if something awful might happen" ];
            const screeningOptions = [ { text: "Not at all", value: 0 }, { text: "Several days", value: 1 }, { text: "More than half the days", value: 2 }, { text: "Nearly every day", value: 3 } ];
            
            const screeningCompleted = localStorage.getItem(`screeningCompleted_${currentUserId}`);
            if (screeningCompleted) {
                document.getElementById('screening-intro-text').classList.add('hidden');
                document.getElementById('screening-complete-text').classList.remove('hidden');
                document.getElementById('screening-btn-text').textContent = "Retake Screening";
                verifiedBadge.classList.remove('hidden');
            }

            function createQuestion(questionText, groupName, index) {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'p-3 rounded-lg bg-black/20';
                let optionsHtml = '<div class="flex flex-wrap gap-x-4 gap-y-2 mt-2">';
                screeningOptions.forEach(opt => {
                    const optionId = `${groupName}-q${index}-opt${opt.value}`;
                    optionsHtml += `
                        <div class="flex items-center">
                            <input type="radio" id="${optionId}" name="${groupName}-q${index}" value="${opt.value}" class="w-4 h-4 text-green-600 bg-gray-700 border-gray-600 focus:ring-green-500">
                            <label for="${optionId}" class="ml-2 text-sm text-gray-300">${opt.text}</label>
                        </div>`;
                });
                optionsHtml += '</div>';
                questionDiv.innerHTML = `<p class="font-semibold text-gray-200">${index + 1}. Over the last 2 weeks, how often have you been bothered by the following problem?</p><p class="mt-1 text-gray-300"><em>${questionText}</em></p>${optionsHtml}`;
                return questionDiv;
            }

            function populateQuestions() {
                const screeningQuestionsContainer = document.getElementById('screening-questions-container');
                screeningQuestionsContainer.innerHTML = '';
                const phq9Header = document.createElement('h4');
                phq9Header.className = 'text-lg font-bold text-green-400 border-b border-green-700 pb-1 mb-2';
                phq9Header.textContent = 'Depression Screening (PHQ-9)';
                screeningQuestionsContainer.appendChild(phq9Header);
                phq9Questions.forEach((q, i) => screeningQuestionsContainer.appendChild(createQuestion(q, 'phq9', i)));
                const gad7Header = document.createElement('h4');
                gad7Header.className = 'text-lg font-bold text-green-400 border-b border-green-700 pb-1 mb-2 mt-6';
                gad7Header.textContent = 'Anxiety Screening (GAD-7)';
                screeningQuestionsContainer.appendChild(gad7Header);
                gad7Questions.forEach((q, i) => screeningQuestionsContainer.appendChild(createQuestion(q, 'gad7', i)));
            }

            // START OF EDIT: Refactored handleSubmit and generateAndSendReport for better error handling
            async function handleSubmit() {
                let phqScore = 0, gadScore = 0, allAnswered = true;
                for (let i = 0; i < phq9Questions.length; i++) {
                    const selected = document.querySelector(`input[name="phq9-q${i}"]:checked`);
                    if (selected) { phqScore += parseInt(selected.value); } else { allAnswered = false; break; }
                }
                if (allAnswered) {
                    for (let i = 0; i < gad7Questions.length; i++) {
                        const selected = document.querySelector(`input[name="gad7-q${i}"]:checked`);
                        if (selected) { gadScore += parseInt(selected.value); } else { allAnswered = false; break; }
                    }
                }

                if (!allAnswered) {
                    showNotification("Please answer all questions before submitting.", "error");
                    return;
                }
                
                submitScreeningBtn.disabled = true;
                submitScreeningBtn.textContent = 'Processing...';
                
                const rawAnswers = { phq9: {}, gad7: {} };
                document.querySelectorAll('#screening-questions-container input:checked').forEach(input => {
                    const parts = input.name.split('-'); // e.g., 'phq9-q0'
                    rawAnswers[parts[0]][parts[1]] = parseInt(input.value);
                });
                
                // This function now handles UI updates and error notifications.
                await generateAndSendReport(phqScore, gadScore, rawAnswers);
            }
            
            async function generateAndSendReport(phqScore, gadScore, rawAnswers) {
                const systemInstruction = `You are a mental health assistant. Your task is to analyze the results of a PHQ-9 and GAD-7 screening and generate a concise, neutral, and informative report for a wellness coordinator. DO NOT provide a diagnosis. Stick to observational language.`;
                const prompt = `A student has completed a mental health screening. Analyze the following results and generate a report.
                    **Scores:**
                    - PHQ-9 Score: ${phqScore} out of 27
                    - GAD-7 Score: ${gadScore} out of 21
                    **Interpretation Guide:**
                    - PHQ-9 (Depression): 5-9 (Mild), 10-14 (Moderate), 15-19 (Moderately Severe), 20-27 (Severe)
                    - GAD-7 (Anxiety): 5-9 (Mild), 10-14 (Moderate), 15-21 (Severe)
                    **Raw Answer Details (0=Not at all, 1=Several days, 2=More than half the days, 3=Nearly every day):**
                    - PHQ-9 Answers: ${JSON.stringify(rawAnswers.phq9)}
                    - GAD-7 Answers: ${JSON.stringify(rawAnswers.gad7)}
                    **Task:**
                    1. State scores and severity levels.
                    2. Identify top 2-3 most frequent symptoms (scores of 2 or 3).
                    3. Note the response to PHQ-9 Question 9 (self-harm), if > 0.
                    4. Conclude with a neutral summary.`;

                try {
                    const reportText = await getGeminiResponse(prompt, systemInstruction);

                    if (!db || !currentUserId) {
                        throw new Error("User is not properly authenticated.");
                    }

                    const reportRef = collection(db, `artifacts/${sanitizedAppId}/public/data/mental_health_reports`);
                    await addDoc(reportRef, {
                        userId: currentUserId,
                        report: reportText,
                        phqScore: phqScore,
                        gadScore: gadScore,
                        createdAt: serverTimestamp()
                    });

                    // On success, update UI and show success notification
                    localStorage.setItem(`screeningCompleted_${currentUserId}`, 'true');
                    document.getElementById('screening-intro-text').classList.add('hidden');
                    document.getElementById('screening-complete-text').classList.remove('hidden');
                    document.getElementById('screening-btn-text').textContent = "Retake Screening";
                    verifiedBadge.classList.remove('hidden');
                    screeningModal.classList.add('hidden');
                    showNotification("Screening submitted successfully!", "success");

                } catch (error) {
                    console.error("Error submitting screening report:", error);
                    showNotification(`Failed to submit screening. This may be a permission issue with the database. Please check the console for errors.`, "error");
                } finally {
                    // Always re-enable the button, whether it succeeded or failed
                    submitScreeningBtn.disabled = false;
                    submitScreeningBtn.textContent = 'Submit';
                }
            }
            // END OF EDIT

            startScreeningBtn.addEventListener('click', () => {
                populateQuestions();
                screeningModal.classList.remove('hidden');
            });
            closeScreeningModalBtn.addEventListener('click', () => screeningModal.classList.add('hidden'));
            submitScreeningBtn.addEventListener('click', handleSubmit);
        }
        
        // --- Other Features ---
        function initializeStudyHelp() { /* Placeholder */ }
        function initializeSerenityMap() { /* Placeholder */ }
        function initializeMusicPlayer() { /* Placeholder */ }
        // START OF EDIT: Added placeholder functions
        function initializeJournaling() { /* Placeholder */ }
        function setupJournalEventListeners() { /* Placeholder */ }
        function initializeOfflineCopingKit() { /* Placeholder */ }
        // END OF EDIT
       
        // --- END OF FIX ---
        

        // --- Firebase Auth and App Initialization ---
        try {
            const app = initializeApp(finalFirebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization failed. Chat features will be disabled.", e);
        }
        
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUserId = user.uid;
                let storedName = localStorage.getItem('anonymousUserName');
                if (!storedName) {
                    storedName = generateAnonymousName();
                    localStorage.setItem('anonymousUserName', storedName);
                }
                currentUserAnonymousName = user.isAnonymous ? storedName : (user.displayName || storedName);
                const userNameElement = document.getElementById('user-anonymous-name');
                if (userNameElement) userNameElement.textContent = currentUserAnonymousName;
                
                initializeAssignments();
                initializeJournaling(); 
                initializeMentalHealthScreening();
                initializeNotifications(); 
            } else {
                currentUserId = null;
                currentUserAnonymousName = "Guest";
                const userNameElement = document.getElementById('user-anonymous-name');
                if (userNameElement) userNameElement.textContent = currentUserAnonymousName;
                if(unsubscribeFromNotifications) unsubscribeFromNotifications();
            }
        });

        document.addEventListener('DOMContentLoaded', async () => {
            initializePage();
            loadProfilePic();
            populateEmotePicker();
            
            // Initialize all widgets and features
            initializeMusicPlayer();
            initializeSerenityMap();
            initializePeerChat();
            initializeAiChat();
            initializeProfilePic();
            initializeOfflineCopingKit(); 
            initializeStudyHelp(); 
            initializeMeditationWidget();

            // Setup event listeners
            setupAssignmentEventListeners();
            setupJournalEventListeners(); 
            document.getElementById('notification-close-btn').addEventListener('click', () => notificationBanner.classList.add('hidden'));
            helpfulLinkBtn.addEventListener('click', async () => {
                const prompt = "Generate a single, helpful and meaningful link for a student looking to improve their well-being or productivity. Provide only the URL and a very short description, separated by a pipe |. For example: `https://www.example.com | A site for mindfulness`";
                helpfulLinkBtn.disabled = true;
                helpfulLinkBtn.textContent = 'Finding...';
                const response = await getGeminiResponse(prompt);
                const parts = response.split('|');
                if (parts.length === 2) {
                    const newListItem = document.createElement('li');
                    newListItem.innerHTML = `<a href="${parts[0].trim()}" target="_blank" class="hover:text-green-400">‚úß ${parts[1].trim()}</a>`;
                    helpfulLinksList.appendChild(newListItem);
                } else {
                     console.warn("Could not parse helpful link response:", response);
                }
                helpfulLinkBtn.disabled = false;
                helpfulLinkBtn.textContent = '‚ú® Find a Link';
            });
            const sosBtn = document.getElementById('sos-btn');
            const sosSidebar = document.getElementById('sos-sidebar');
            const closeSosSidebarBtn = document.getElementById('close-sos-sidebar');
            sosBtn.addEventListener('click', () => sosSidebar.classList.remove('translate-x-full'));
            closeSosSidebarBtn.addEventListener('click', () => sosSidebar.classList.add('translate-x-full'));

            lucide.createIcons();

            // Authenticate user
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Initial authentication failed:", error);
                if (!auth.currentUser) {
                     try { await signInAnonymously(auth); } 
                     catch (anonError) { console.error("Fallback anonymous sign-in also failed.", anonError); }
                }
            }
        });

    </script>
</body>

</html>

